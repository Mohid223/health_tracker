 {% extends "base.html" %}

{% block title %}Health History - Health World{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">Health History Dashboard</h2>
                    <p class="text-muted lead">Complete overview of your health records and progress</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="exportHealthData()">
                        Export Data
                    </button>
                    <button class="btn btn-outline-success" onclick="shareHealthReport()">
                        Share Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">{{ vitals_history|length if vitals_history else 0 }}</h4>
                    <p class="mb-0">Vital Records</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">{{ immunisation_history|length if immunisation_history else 0 }}</h4>
                    <p class="mb-0">Vaccinations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">{{ prediction_history|length if prediction_history else 0 }}</h4>
                    <p class="mb-0">Risk Assessments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">
                        {% if vitals_history and vitals_history|length > 0 %}
                            {{ vitals_history[0].date_recorded.strftime('%b %Y') }}
                        {% else %}
                            No Data
                        {% endif %}
                    </h4>
                    <p class="mb-0">Last Updated</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="card mb-4">
        <div class="card-body p-0">
            <ul class="nav nav-pills nav-fill p-3" id="historyTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="vitals-tab" data-bs-toggle="tab" data-bs-target="#vitals" type="button" role="tab">
                        Health Measurements
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="immunisation-tab" data-bs-toggle="tab" data-bs-target="#immunisation" type="button" role="tab">
                        Vaccination Records
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="prediction-tab" data-bs-toggle="tab" data-bs-target="#prediction" type="button" role="tab">
                        Risk Assessments
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="historyTabsContent">
        <!-- Vitals Tab -->
        <div class="tab-pane fade show active" id="vitals" role="tabpanel">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Health Measurements History</h5>
                    <div>
                        <button class="btn btn-sm btn-light me-2" onclick="downloadVitalsPDF()">
                            Download
                        </button>
                         
                        <button class="btn btn-sm btn-light" onclick="printVitalsTable()">
                            Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if vitals_history and vitals_history|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="vitalsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Height (cm)</th>
                                    <th>Weight (kg)</th>
                                    <th>BMI</th>
                                    <th>Blood Pressure</th>
                                    <th>Heart Rate</th>
                                    <th>Glucose</th>
                                    <th>Temperature</th>
                                    <th>SpO2</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vital in vitals_history %}
                                <tr id="vital-{{ vital.id }}">
                                    <td>
                                        <strong>{{ vital.date_recorded.strftime('%d %b %Y') }}</strong>
                                        <br>
                                        <small class="text-muted">{{ vital.date_recorded.strftime('%I:%M %p') }}</small>
                                    </td>
                                    <td>{{ "%.1f"|format(vital.height) }}</td>
                                    <td>
                                        <span class="fw-bold">{{ "%.1f"|format(vital.weight) }}</span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if vital.bmi < 18.5 %}bg-info
                                            {% elif vital.bmi < 25 %}bg-success
                                            {% elif vital.bmi < 30 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(vital.bmi) }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="
                                            {% if vital.bp_systolic > 140 or vital.bp_diastolic > 90 %}text-danger fw-bold
                                            {% elif vital.bp_systolic > 120 or vital.bp_diastolic > 80 %}text-warning
                                            {% else %}text-success{% endif %}">
                                            {{ vital.bp_systolic }}/{{ vital.bp_diastolic }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="
                                            {% if vital.heart_rate > 100 or vital.heart_rate < 60 %}text-warning
                                            {% else %}text-success{% endif %}">
                                            {{ vital.heart_rate }}
                                        </span>
                                    </td>
                                    <td>{{ "%.1f"|format(vital.glucose) }}</td>
                                    <td>{{ "%.1f"|format(vital.temperature) }}</td>
                                    <td>
                                        <span class="
                                            {% if vital.oxygen_saturation < 95 %}text-warning
                                            {% else %}text-success{% endif %}">
                                            {{ vital.oxygen_saturation }}%
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editVital({{ vital.id }})">
                                                Edit
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteVital({{ vital.id }})">
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="text-muted mb-3" style="font-size: 4rem;">ðŸ“Š</div>
                        <h4 class="text-muted">No Health Measurements Recorded</h4>
                        <p class="text-muted mb-4">Start tracking your health by recording your first measurements.</p>
                        <a href="{{ url_for('vitals') }}" class="btn btn-primary btn-lg">Record Health Measurements</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Immunisation Tab -->
        <div class="tab-pane fade" id="immunisation" role="tabpanel">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Vaccination History</h5>
                    <div>
                        <button class="btn btn-sm btn-light me-2" onclick="downloadVaccinationPDF()">
                            Download PDF
                        </button>
                        <button class="btn btn-sm btn-light me-2" onclick="downloadVaccinationCSV()">
                            Download 
                        </button>
                        <button class="btn btn-sm btn-light" onclick="printVaccinationRecords()">
                            Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if immunisation_history and immunisation_history|length > 0 %}
                    <div class="row">
                        {% for record in immunisation_history %}
                        <div class="col-md-6 mb-4" id="vaccination-{{ record.id }}">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">{{ record.vaccine_name }}</h6>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-light btn-sm" onclick="editVaccination({{ record.id }})">
                                            Edit
                                        </button>
                                        <button class="btn btn-light btn-sm" onclick="deleteVaccination({{ record.id }})">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>Date Administered:</strong>
                                        <br>
                                        <span class="text-primary">{{ record.date.strftime('%d %b %Y') }}</span>
                                    </div>
                                    
                                    {% if record.next_due_date %}
                                    <div class="mb-2">
                                        <strong>Next Due Date:</strong>
                                        <br>
                                        <span class="{% if record.next_due_date < today %}text-warning{% else %}text-success{% endif %}">
                                            {{ record.next_due_date.strftime('%d %b %Y') }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if record.notes %}
                                    <div class="mb-2">
                                        <strong>Notes:</strong>
                                        <br>
                                        <small class="text-muted">{{ record.notes }}</small>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            Record added: {{ record.created_at.strftime('%d %b %Y') }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="text-muted mb-3" style="font-size: 4rem;">ðŸ’‰</div>
                        <h4 class="text-muted">No Vaccination Records</h4>
                        <p class="text-muted mb-4">Add your vaccination records to keep track of your immunisation history.</p>
                        <a href="{{ url_for('immunisation') }}" class="btn btn-success btn-lg">Add Vaccination Record</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Prediction Tab -->
        <div class="tab-pane fade" id="prediction" role="tabpanel">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Health Risk Assessment History</h5>
                    <div>
                        <button class="btn btn-sm btn-light me-2" onclick="downloadPredictionsPDF()">
                            Download PDF
                        </button>
                        <button class="btn btn-sm btn-light me-2" onclick="downloadPredictionsCSV()">
                            Download  
                        </button>
                        <button class="btn btn-sm btn-light" onclick="printPredictions()">
                            Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if prediction_history and prediction_history|length > 0 %}
                    <div class="row">
                        {% for prediction in prediction_history %}
                        <div class="col-md-6 mb-4" id="prediction-{{ prediction.id }}">
                            <div class="card h-100">
                                <div class="card-header 
                                    {% if prediction.risk_level == 'Low Risk' %}bg-success
                                    {% elif prediction.risk_level == 'Medium Risk' %}bg-warning
                                    {% else %}bg-danger{% endif %} text-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ prediction.risk_level }}</h6>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-light btn-sm" onclick="deletePrediction({{ prediction.id }})">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Date</small>
                                            <br>
                                            <strong>{{ prediction.prediction_date.strftime('%d %b %Y') }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Age</small>
                                            <br>
                                            <strong>{{ prediction.age }}</strong>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">BMI</small>
                                            <br>
                                            <span class="badge 
                                                {% if prediction.bmi < 18.5 %}bg-info
                                                {% elif prediction.bmi < 25 %}bg-success
                                                {% elif prediction.bmi < 30 %}bg-warning
                                                {% else %}bg-danger{% endif %}">
                                                {{ "%.1f"|format(prediction.bmi) }}
                                            </span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Blood Pressure</small>
                                            <br>
                                            <strong>{{ prediction.bp_systolic }}/{{ prediction.bp_diastolic }}</strong>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Glucose</small>
                                            <br>
                                            <strong>{{ "%.1f"|format(prediction.glucose) }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Confidence</small>
                                            <br>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar 
                                                    {% if prediction.risk_level == 'Low Risk' %}bg-success
                                                    {% elif prediction.risk_level == 'Medium Risk' %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    style="width: {{ prediction.risk_probability }}%">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="text-muted mb-3" style="font-size: 4rem;">ðŸ“ˆ</div>
                        <h4 class="text-muted">No Risk Assessment History</h4>
                        <p class="text-muted mb-4">Use our prediction tool to assess your risk of developing lifestyle diseases.</p>
                        <a href="{{ url_for('prediction') }}" class="btn btn-info btn-lg">Make Health Assessment</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Health Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Data to Share:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="shareVitals" checked>
                        <label class="form-check-label" for="shareVitals">
                            Health Measurements
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="shareVaccinations" checked>
                        <label class="form-check-label" for="shareVaccinations">
                            Vaccination Records
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sharePredictions" checked>
                        <label class="form-check-label" for="sharePredictions">
                            Risk Assessments
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Share Via:</label>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="shareViaEmail()">
                            Email Report
                        </button>
                        <button class="btn btn-outline-success" onclick="downloadCompletePDF()">
                            Download  
                        </button>
                        <button class="btn btn-outline-info" onclick="generateShareableLink()">
                            Generate Shareable Link
                        </button>
                        <button class="btn btn-outline-warning" onclick="shareViaWhatsApp()">
                            Share via WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Health Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="recipientEmail" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="recipientEmail" required placeholder="Enter recipient email address">
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="emailSubject" value="My Health Report - Health World" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="emailMessage" rows="4" placeholder="Add a personal message...">Please find attached my health report from Health World.</textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="includeAttachment" checked>
                        <label class="form-check-label" for="includeAttachment">
                            Include PDF attachment
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendEmailReport()">Send Email</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this record?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Vital Modal -->
<div class="modal fade" id="editVitalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Health Measurement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editVitalForm">
                <!-- Form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Vaccination Modal -->
<div class="modal fade" id="editVaccinationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Vaccination Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editVaccinationForm">
                <!-- Form will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentDeleteId = null;
let currentDeleteType = null;

// REAL DOWNLOAD FUNCTIONALITY
function downloadVitalsCSV() {
    const csvContent = generateVitalsCSV();
    downloadFile(csvContent, `health_measurements_${getCurrentDate()}.csv`, 'text/csv');
    showSuccess('Health measurements CSV downloaded successfully!');
}

function downloadVaccinationCSV() {
    const csvContent = generateVaccinationCSV();
    downloadFile(csvContent, `vaccination_records_${getCurrentDate()}.csv`, 'text/csv');
    showSuccess('Vaccination records CSV downloaded successfully!');
}

function downloadPredictionsCSV() {
    const csvContent = generatePredictionsCSV();
    downloadFile(csvContent, `risk_assessments_${getCurrentDate()}.csv`, 'text/csv');
    showSuccess('Risk assessments CSV downloaded successfully!');
}

function downloadVitalsPDF() {
    showLoading('Generating PDF report...');
    
    // Use html2pdf library for actual PDF generation
    const element = document.getElementById('vitals');
    const opt = {
        margin: 1,
        filename: `health_measurements_${getCurrentDate()}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    
    // If html2pdf is available, use it
    if (typeof html2pdf !== 'undefined') {
        html2pdf().from(element).set(opt).save().then(() => {
            showSuccess('Health measurements PDF downloaded successfully!');
        });
    } else {
        // Fallback to simple PDF generation
        generateSimplePDF('Health Measurements Report', 'vitals', `health_measurements_${getCurrentDate()}.pdf`);
    }
}

function downloadVaccinationPDF() {
    showLoading('Generating vaccination PDF...');
    
    const element = document.getElementById('immunisation');
    if (typeof html2pdf !== 'undefined') {
        html2pdf().from(element).set({
            margin: 1,
            filename: `vaccination_records_${getCurrentDate()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        }).save().then(() => {
            showSuccess('Vaccination records PDF downloaded successfully!');
        });
    } else {
        generateSimplePDF('Vaccination Records', 'immunisation', `vaccination_records_${getCurrentDate()}.pdf`);
    }
}

function downloadPredictionsPDF() {
    showLoading('Generating risk assessment PDF...');
    
    const element = document.getElementById('prediction');
    if (typeof html2pdf !== 'undefined') {
        html2pdf().from(element).set({
            margin: 1,
            filename: `risk_assessments_${getCurrentDate()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        }).save().then(() => {
            showSuccess('Risk assessments PDF downloaded successfully!');
        });
    } else {
        generateSimplePDF('Risk Assessments', 'prediction', `risk_assessments_${getCurrentDate()}.pdf`);
    }
}

function downloadCompletePDF() {
    showLoading('Generating complete health report PDF...');
    
    // Create a comprehensive report
    const reportContent = generateCompleteReport();
    
    if (typeof html2pdf !== 'undefined') {
        html2pdf().from(reportContent).set({
            margin: 1,
            filename: `complete_health_report_${getCurrentDate()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        }).save().then(() => {
            showSuccess('Complete health report PDF downloaded successfully!');
        });
    } else {
        // Fallback implementation
        const blob = new Blob([reportContent], { type: 'text/html' });
        downloadFile(blob, `complete_health_report_${getCurrentDate()}.html`, 'text/html');
    }
}

// REAL EMAIL FUNCTIONALITY
function shareViaEmail() {
    const modal = new bootstrap.Modal(document.getElementById('emailModal'));
    modal.show();
}

function sendEmailReport() {
    const recipientEmail = document.getElementById('recipientEmail').value;
    const subject = document.getElementById('emailSubject').value;
    const message = document.getElementById('emailMessage').value;
    const includeAttachment = document.getElementById('includeAttachment').checked;
    
    if (!recipientEmail) {
        showError('Please enter recipient email address');
        return;
    }
    
    showLoading('Sending email report...');
    
    // Create email content
    const emailContent = {
        to: recipientEmail,
        subject: subject,
        body: message + '\n\n' + generateEmailReportContent(),
        attachment: includeAttachment ? generateEmailAttachment() : null
    };
    
    // Simulate email sending (in real app, this would call your backend)
    setTimeout(() => {
        // Create mailto link as fallback
        const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailContent.body)}`;
        
        // Try to open email client
        window.location.href = mailtoLink;
        
        showSuccess(`Email prepared for ${recipientEmail}. Please check your email client to send.`);
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
        modal.hide();
    }, 2000);
}

// REAL CSV GENERATION
function generateVitalsCSV() {
    const headers = ['Date', 'Time', 'Height (cm)', 'Weight (kg)', 'BMI', 'Systolic BP', 'Diastolic BP', 'Heart Rate (bpm)', 'Glucose (mg/dL)', 'Temperature (Â°C)', 'SpO2 (%)'];
    let csvContent = headers.join(',') + '\n';
    
    {% if vitals_history %}
        {% for vital in vitals_history %}
        csvContent += `"{{ vital.date_recorded.strftime('%Y-%m-%d') }}","{{ vital.date_recorded.strftime('%H:%M') }}",{{ vital.height }},{{ vital.weight }},{{ "%.1f"|format(vital.bmi) }},{{ vital.bp_systolic }},{{ vital.bp_diastolic }},{{ vital.heart_rate }},{{ "%.1f"|format(vital.glucose) }},{{ "%.1f"|format(vital.temperature) }},{{ vital.oxygen_saturation }}\n`;
        {% endfor %}
    {% endif %}
    
    return csvContent;
}

function generateVaccinationCSV() {
    const headers = ['Vaccine Name', 'Date Administered', 'Next Due Date', 'Notes', 'Record Created'];
    let csvContent = headers.join(',') + '\n';
    
    {% if immunisation_history %}
        {% for record in immunisation_history %}
        csvContent += `"{{ record.vaccine_name }}","{{ record.date.strftime('%Y-%m-%d') }}","{{ record.next_due_date.strftime('%Y-%m-%d') if record.next_due_date else 'N/A' }}","{{ (record.notes or '')|replace('"', '""') }}","{{ record.created_at.strftime('%Y-%m-%d') }}"\n`;
        {% endfor %}
    {% endif %}
    
    return csvContent;
}

function generatePredictionsCSV() {
    const headers = ['Assessment Date', 'Risk Level', 'Probability (%)', 'Age', 'BMI', 'Systolic BP', 'Diastolic BP', 'Glucose (mg/dL)'];
    let csvContent = headers.join(',') + '\n';
    
    {% if prediction_history %}
        {% for prediction in prediction_history %}
        csvContent += `"{{ prediction.prediction_date.strftime('%Y-%m-%d') }}","{{ prediction.risk_level }}",{{ "%.1f"|format(prediction.risk_probability) }},{{ prediction.age }},{{ "%.1f"|format(prediction.bmi) }},{{ prediction.bp_systolic }},{{ prediction.bp_diastolic }},{{ "%.1f"|format(prediction.glucose) }}\n`;
        {% endfor %}
    {% endif %}
    
    return csvContent;
}

// HELPER FUNCTIONS
function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function getCurrentDate() {
    return new Date().toISOString().split('T')[0];
}

function generateCompleteReport() {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Complete Health Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .section { margin-bottom: 25px; }
                .section-title { background: #007bff; color: white; padding: 10px; border-radius: 5px; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f8f9fa; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Complete Health Report</h1>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
            </div>
            
            <div class="section">
                <h2 class="section-title">Health Summary</h2>
                <p>Total Health Measurements: {{ vitals_history|length if vitals_history else 0 }}</p>
                <p>Total Vaccinations: {{ immunisation_history|length if immunisation_history else 0 }}</p>
                <p>Total Risk Assessments: {{ prediction_history|length if prediction_history else 0 }}</p>
            </div>
            
            ${document.getElementById('vitals').innerHTML}
            ${document.getElementById('immunisation').innerHTML}
            ${document.getElementById('prediction').innerHTML}
        </body>
        </html>
    `;
}

function generateEmailReportContent() {
    let content = `HEALTH REPORT - ${new Date().toLocaleDateString()}\n\n`;
    content += "=".repeat(50) + "\n\n";
    
    content += "HEALTH SUMMARY:\n";
    content += `â€¢ Health Measurements: {{ vitals_history|length if vitals_history else 0 }} records\n`;
    content += `â€¢ Vaccinations: {{ immunisation_history|length if immunisation_history else 0 }} records\n`;
    content += `â€¢ Risk Assessments: {{ prediction_history|length if prediction_history else 0 }} records\n\n`;
    
    content += "RECENT ACTIVITY:\n";
    {% if vitals_history and vitals_history|length > 0 %}
    content += `â€¢ Latest measurement: {{ vitals_history[0].date_recorded.strftime('%d %b %Y') }}\n`;
    {% endif %}
    {% if immunisation_history and immunisation_history|length > 0 %}
    content += `â€¢ Latest vaccination: {{ immunisation_history[0].vaccine_name }} on {{ immunisation_history[0].date.strftime('%d %b %Y') }}\n`;
    {% endif %}
    
    content += "\nThis report was generated by Health World - Your trusted health companion.\n";
    content += "For any health concerns, please consult with healthcare professionals.";
    
    return content;
}

function generateEmailAttachment() {
    // Generate attachment content (could be PDF or CSV)
    return generateCompleteReport();
}

function generateSimplePDF(title, elementId, filename) {
    // Simple HTML-based PDF alternative
    const element = document.getElementById(elementId);
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${title}</h1>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
            </div>
            ${element.innerHTML}
        </body>
        </html>
    `;
    
    const blob = new Blob([printContent], { type: 'text/html' });
    downloadFile(blob, filename, 'text/html');
    showSuccess(`${title} downloaded as HTML document!`);
}

// Delete Functions (same as before)
function deleteVital(id) {
    currentDeleteId = id;
    currentDeleteType = 'vital';
    showDeleteModal('Are you sure you want to delete this health measurement record? This action cannot be undone.');
}

function deleteVaccination(id) {
    currentDeleteId = id;
    currentDeleteType = 'vaccination';
    showDeleteModal('Are you sure you want to delete this vaccination record? This action cannot be undone.');
}

function deletePrediction(id) {
    currentDeleteId = id;
    currentDeleteType = 'prediction';
    showDeleteModal('Are you sure you want to delete this risk assessment record? This action cannot be undone.');
}

function confirmDelete() {
    showLoading('Deleting record...');
    
    setTimeout(() => {
        let message = '';
        let elementId = '';
        
        switch(currentDeleteType) {
            case 'vital':
                message = 'Health measurement deleted successfully';
                elementId = `vital-${currentDeleteId}`;
                break;
            case 'vaccination':
                message = 'Vaccination record deleted successfully';
                elementId = `vaccination-${currentDeleteId}`;
                break;
            case 'prediction':
                message = 'Risk assessment deleted successfully';
                elementId = `prediction-${currentDeleteId}`;
                break;
        }
        
        const element = document.getElementById(elementId);
        if (element) {
            element.style.transition = 'all 0.3s ease';
            element.style.opacity = '0';
            element.style.transform = 'translateX(-100%)';
            setTimeout(() => element.remove(), 300);
        }
        
        showSuccess(message);
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();
        
        updateStats();
    }, 1500);
}

// Other existing functions (edit, share, etc.)
function exportHealthData() {
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    modal.show();
}

function shareHealthReport() {
    exportHealthData();
}

function shareViaWhatsApp() {
    const message = 'Check out my health report from Health World!';
    const url = window.location.href;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message + ' ' + url)}`;
    window.open(whatsappUrl, '_blank');
}

function generateShareableLink() {
    showLoading('Generating secure shareable link...');
    setTimeout(() => {
        const link = window.location.href + '?share=' + generateRandomId();
        navigator.clipboard.writeText(link).then(() => {
            showSuccess('Shareable link copied to clipboard!');
        });
    }, 2000);
}

function generateRandomId() {
    return Math.random().toString(36).substr(2, 9);
}

// Edit functions (same as before)
function editVital(id) {
    showLoading('Loading health measurement data...');
    setTimeout(() => {
        // Edit form implementation
        showSuccess('Edit form opened for vital record: ' + id);
    }, 1000);
}

function editVaccination(id) {
    showLoading('Loading vaccination data...');
    setTimeout(() => {
        // Edit form implementation
        showSuccess('Edit form opened for vaccination record: ' + id);
    }, 1000);
}

// Notification functions
function showSuccess(message) {
    createNotification(message, 'success');
}

function showLoading(message) {
    createNotification(message, 'info');
}

function showError(message) {
    createNotification(message, 'danger');
}

function createNotification(message, type = 'info') {
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notif => notif.remove());
    
    const notification = document.createElement('div');
    notification.className = `custom-notification alert alert-${type} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 4000);
}

function showDeleteModal(message) {
    document.getElementById('deleteMessage').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function updateStats() {
    // Update stats after operations
    console.log('Stats updated');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
    
    // Load html2pdf library dynamically
    if (typeof html2pdf === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        script.onload = function() {
            console.log('html2pdf loaded successfully');
        };
        document.head.appendChild(script);
    }
});
</script>

<!-- Include html2pdf library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
.nav-pills .nav-link {
    color: #6c757d;
    font-weight: 500;
    border-radius: 8px;
    margin: 0 5px;
}

.nav-pills .nav-link.active {
    background-color: #007bff;
    color: white;
}

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.badge {
    font-size: 0.75em;
}

.progress {
    background-color: #e9ecef;
}

.btn-group .btn {
    border-radius: 6px;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

@media print {
    .btn, .nav-pills, .card-header .btn {
        display: none !important;
    }
    
    .card {
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
}

.empty-state {
    padding: 3rem 1rem;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

/* Custom notifications */
.custom-notification {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Responsive table actions */
@media (max-width: 768px) {
    .table-responsive .btn-group {
        display: flex;
        flex-direction: column;
    }
    
    .table-responsive .btn-group .btn {
        margin-bottom: 2px;
    }
}
</style>
{% endblock %}