 {% extends "base.html" %}

{% block title %}Emergency Help - Health Tracker{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Emergency Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger text-center py-3">
                <h2 class="mb-2">Emergency Assistance</h2>
                <p class="lead mb-0">If this is a life-threatening emergency, call emergency services immediately!</p>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Emergency Contacts -->
        <div class="col-lg-4">
            <div class="card border-danger h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-phone-alt me-2"></i>Emergency Contacts
                    </h5>
                </div>
                <div class="card-body">
                    <div class="contact-list">
                        <div class="contact-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-ambulance text-danger me-2"></i>
                                <h6 class="mb-0">Ambulance Service</h6>
                            </div>
                            <p class="mb-1 fw-bold text-dark">Dial: 102 or 108</p>
                            <small class="text-muted">24/7 Emergency Medical Service</small>
                        </div>
                        
                        <div class="contact-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-fire text-warning me-2"></i>
                                <h6 class="mb-0">Fire Department</h6>
                            </div>
                            <p class="mb-1 fw-bold text-dark">Dial: 101</p>
                            <small class="text-muted">Fire and Rescue Services</small>
                        </div>
                        
                        <div class="contact-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-shield-alt text-primary me-2"></i>
                                <h6 class="mb-0">Police Emergency</h6>
                            </div>
                            <p class="mb-1 fw-bold text-dark">Dial: 100</p>
                            <small class="text-muted">Police Emergency Response</small>
                        </div>
                        
                        <div class="contact-item p-3 bg-light rounded">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-hands-helping text-info me-2"></i>
                                <h6 class="mb-0">Disaster Management</h6>
                            </div>
                            <p class="mb-1 fw-bold text-dark">Dial: 1078</p>
                            <small class="text-muted">National Disaster Management</small>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-3 border-top">
                        <button class="btn btn-danger w-100 py-2" onclick="callEmergency('100')">
                            <i class="fas fa-phone me-2"></i>Call Emergency Services (100)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nearby Hospitals -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-hospital me-2"></i>Nearby Hospitals & Emergency Centers
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Location Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Select Your Location Method:</label>
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-primary flex-fill" onclick="useCurrentLocation()">
                                    <i class="fas fa-location-arrow me-2"></i>Use My Current Location
                                </button>
                                <button class="btn btn-outline-primary flex-fill" data-bs-toggle="modal" data-bs-target="#locationModal">
                                    <i class="fas fa-map-marker-alt me-2"></i>Select City
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="locationInfo" class="p-3 bg-light rounded">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Allow location access or select your city to find nearest hospitals
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="hospitalsList" class="mt-3">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-3 d-block"></i>
                            <p>Select your location to find nearby emergency centers</p>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="mapContainer" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Hospital Locations</h6>
                                <span id="currentLocation" class="badge bg-primary"></span>
                            </div>
                            <div id="map" class="p-3">
                                <!-- Map will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Instructions Section remains same -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-first-aid me-2"></i>Emergency Instructions
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ... (same emergency instructions content) ... -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Selection Modal -->
<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Your City</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Choose your city:</label>
                    <select class="form-select" id="citySelect">
                        <option value="">-- Select City --</option>
                        <option value="delhi">Delhi</option>
                        <option value="mumbai">Mumbai</option>
                        <option value="chennai">Chennai</option>
                        <option value="kolkata">Kolkata</option>
                        <option value="bangalore">Bangalore</option>
                        <option value="hyderabad">Hyderabad</option>
                        <option value="ahmedabad">Ahmedabad</option>
                        <option value="pune">Pune</option>
                        <option value="jaipur">Jaipur</option>
                        <option value="lucknow">Lucknow</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Or enter custom location:</label>
                    <input type="text" class="form-control" id="customLocation" placeholder="Enter your area or city">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="useSelectedLocation()">Find Hospitals</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let userLocation = null;
let currentCity = '';

// City coordinates database
const cityCoordinates = {
    'delhi': { lat: 28.6139, lng: 77.2090, name: 'Delhi' },
    'mumbai': { lat: 19.0760, lng: 72.8777, name: 'Mumbai' },
    'chennai': { lat: 13.0827, lng: 80.2707, name: 'Chennai' },
    'kolkata': { lat: 22.5726, lng: 88.3639, name: 'Kolkata' },
    'bangalore': { lat: 12.9716, lng: 77.5946, name: 'Bangalore' },
    'hyderabad': { lat: 17.3850, lng: 78.4867, name: 'Hyderabad' },
    'ahmedabad': { lat: 23.0225, lng: 72.5714, name: 'Ahmedabad' },
    'pune': { lat: 18.5204, lng: 73.8567, name: 'Pune' },
    'jaipur': { lat: 26.9124, lng: 75.7873, name: 'Jaipur' },
    'lucknow': { lat: 26.8467, lng: 80.9462, name: 'Lucknow' }
};

function callEmergency(number) {
    if (confirm(`Call emergency services at ${number}?`)) {
        window.location.href = `tel:${number}`;
    }
}

function useCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                currentCity = 'Current Location';
                updateLocationInfo('Using your current location');
                showLoadingState();
                fetchHospitals();
            },
            function(error) {
                handleLocationError('Please allow location access or select your city manually.');
            }
        );
    } else {
        handleLocationError('Geolocation is not supported by your browser. Please select your city.');
    }
}

function useSelectedLocation() {
    const citySelect = document.getElementById('citySelect').value;
    const customLocation = document.getElementById('customLocation').value;
    
    if (citySelect) {
        // Use selected city
        userLocation = cityCoordinates[citySelect];
        currentCity = userLocation.name;
        updateLocationInfo(`Searching in ${currentCity}`);
    } else if (customLocation) {
        // For custom location, we'll use geocoding (simulated here)
        currentCity = customLocation;
        updateLocationInfo(`Searching in ${customLocation}`);
        // In real implementation, you would use Google Geocoding API here
        userLocation = getRandomCoordinates(); // Simulated coordinates
    } else {
        alert('Please select a city or enter a location.');
        return;
    }
    
    showLoadingState();
    fetchHospitals();
    $('#locationModal').modal('hide');
}

function updateLocationInfo(message) {
    document.getElementById('locationInfo').innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle text-success me-2"></i>
            <span class="text-success">${message}</span>
        </div>
    `;
    document.getElementById('currentLocation').textContent = currentCity;
}

function getRandomCoordinates() {
    // Simulate coordinates for demo purposes
    // In real app, use Google Geocoding API
    const lat = 28.6139 + (Math.random() - 0.5) * 0.1;
    const lng = 77.2090 + (Math.random() - 0.5) * 0.1;
    return { lat, lng };
}

function showLoadingState() {
    document.getElementById('hospitalsList').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p class="text-muted">Finding nearby hospitals in ${currentCity}...</p>
        </div>
    `;
    document.getElementById('mapContainer').style.display = 'block';
}

function fetchHospitals() {
    // Simulate API call - in real app, this would be your backend API
    setTimeout(() => {
        const hospitals = generateSampleHospitals();
        displayHospitals(hospitals);
        showMap(hospitals);
    }, 1500);
}

function generateSampleHospitals() {
    // Generate sample hospital data based on location
    const hospitalNames = [
        'City General Hospital',
        'Metropolitan Medical Center',
        'Emergency Care Hospital',
        'Community Health Center',
        'Regional Trauma Center',
        'Public District Hospital',
        'Medical Trust Hospital',
        'Emergency Response Center'
    ];
    
    const hospitals = [];
    for (let i = 0; i < 6; i++) {
        hospitals.push({
            id: i + 1,
            name: hospitalNames[i],
            address: `Medical Street, Sector ${i + 1}, ${currentCity}`,
            phone: `+91 ${Math.floor(1000000000 + Math.random() * 9000000000)}`,
            distance: `${(Math.random() * 5 + 0.5).toFixed(1)} km`,
            lat: userLocation.lat + (Math.random() - 0.5) * 0.01,
            lng: userLocation.lng + (Math.random() - 0.5) * 0.01
        });
    }
    
    return hospitals.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
}

function handleLocationError(message) {
    document.getElementById('locationInfo').innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            <span class="text-warning">${message}</span>
        </div>
    `;
}

function displayHospitals(hospitals) {
    const hospitalsList = document.getElementById('hospitalsList');
    
    if (hospitals.length === 0) {
        hospitalsList.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No hospitals found in ${currentCity}.
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Found ${hospitals.length} hospitals near you</h6>
            <span class="badge bg-primary">${currentCity}</span>
        </div>
        <div class="row g-3">
    `;
    
    hospitals.forEach(hospital => {
        html += `
            <div class="col-md-6">
                <div class="card h-100 border-success hospital-card">
                    <div class="card-body">
                        <h6 class="card-title text-primary">${hospital.name}</h6>
                        <div class="hospital-details">
                            <p class="mb-2 small">
                                <i class="fas fa-map-marker-alt text-muted me-2"></i> 
                                ${hospital.address}
                            </p>
                            <p class="mb-2 small">
                                <i class="fas fa-phone text-muted me-2"></i> 
                                ${hospital.phone}
                            </p>
                            <p class="mb-3 small">
                                <i class="fas fa-walking text-muted me-2"></i> 
                                ${hospital.distance} away
                            </p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-fill" 
                                    onclick="callEmergency('${hospital.phone}')">
                                <i class="fas fa-phone me-1"></i> Call
                            </button>
                            <button class="btn btn-outline-success btn-sm flex-fill" 
                                    onclick="getDirections(${hospital.lat}, ${hospital.lng})">
                                <i class="fas fa-directions me-1"></i> Directions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    hospitalsList.innerHTML = html;
}

function showMap(hospitals) {
    const mapContainer = document.getElementById('map');
    mapContainer.innerHTML = `
        <div class="text-center p-4 bg-light rounded">
            <i class="fas fa-map-marked-alt fa-2x text-primary mb-3"></i>
            <h6 class="text-dark mb-3">Hospital Locations in ${currentCity}</h6>
            <p class="text-muted mb-4">Showing ${hospitals.length} medical facilities near you</p>
            <div class="hospital-locations mb-4 text-start">
                ${hospitals.map(hospital => `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-hospital text-danger me-2"></i>
                        <div>
                            <div class="fw-bold">${hospital.name}</div>
                            <small class="text-muted">${hospital.distance} away</small>
                        </div>
                    </div>
                `).join('')}
            </div>
            <button class="btn btn-primary" onclick="openGoogleMaps()">
                <i class="fas fa-external-link-alt me-2"></i>Open in Google Maps
            </button>
        </div>
    `;
}

function getDirections(lat, lng) {
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
    window.open(url, '_blank');
}

function openGoogleMaps() {
    if (userLocation) {
        const url = `https://www.google.com/maps/search/hospitals/@${userLocation.lat},${userLocation.lng},12z`;
        window.open(url, '_blank');
    } else {
        window.open('https://www.google.com/maps/search/hospitals/', '_blank');
    }
}

// Initialize with popular cities list
document.addEventListener('DOMContentLoaded', function() {
    // You can add any initialization code here
});
</script>

<style>
.contact-item {
    border-left: 4px solid #dc3545;
    transition: all 0.3s ease;
}

.contact-item:hover {
    background-color: #f8d7da !important;
    transform: translateX(5px);
}

.hospital-card {
    transition: all 0.3s ease;
}

.hospital-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.alert {
    border: none;
    border-radius: 10px;
}

#locationInfo {
    transition: all 0.3s ease;
}
</style>
{% endblock %}