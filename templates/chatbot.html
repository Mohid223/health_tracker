 {% extends "base.html" %}

{% block title %}Health Chatbot{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">Health Assistant Chatbot</h4>
                            <small>Ask me about symptoms, health tips, or general health questions</small>
                        </div>
                        <button id="clear-btn" class="btn btn-outline-light btn-sm">Clear Chat</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chat Messages Container -->
                    <div id="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #f8f9fa;">
                        <div class="text-center text-muted" id="welcome-message">
                            <p>ðŸ‘‹ Hello! I'm your Health Assistant. How can I help you today?</p>
                            <small>You can ask me about symptoms, medications, exercise, diet, or general health tips</small>
                        </div>
                        <!-- Chat messages will be dynamically added here -->
                    </div>
                    
                    <!-- Message Input -->
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your health question here..." autocomplete="off">
                        <button id="send-btn" class="btn btn-primary">
                            <span id="send-text">Send</span>
                            <span id="loading-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                    
                    <!-- Quick Suggestions -->
                    <div class="mt-3">
                        <small class="text-muted d-block mb-2">Quick questions you can ask:</small>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="What should I do for fever?">Fever</button>
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="How to lower blood pressure?">Blood Pressure</button>
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="What are healthy eating tips?">Diet Tips</button>
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="Best exercises for heart health">Exercise</button>
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="How much water should I drink daily?">Hydration</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const sendText = document.getElementById('send-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const quickQuestions = document.querySelectorAll('.quick-question');

    // Load chat history when page loads
    loadChatHistory();

    // Send message on button click
    sendBtn.addEventListener('click', sendMessage);

    // Send message on Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Clear chat history
    clearBtn.addEventListener('click', clearChatHistory);

    // Quick question buttons
    quickQuestions.forEach(button => {
        button.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            messageInput.value = question;
            sendMessage();
        });
    });

    // Auto-scroll to bottom of chat
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Load chat history from server
    function loadChatHistory() {
        fetch('/api/chat/history')
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    welcomeMessage.style.display = 'none';
                    data.forEach(message => {
                        addMessageToChat(message.message, message.is_user, message.timestamp);
                    });
                }
                scrollToBottom();
            })
            .catch(error => {
                console.error('Failed to load chat history:', error);
            });
    }

    // Add message to chat interface
    function addMessageToChat(message, isUser, timestamp = null) {
        const timestampText = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'd-flex justify-content-end mb-3' : 'd-flex justify-content-start mb-3';

        const messageBubble = document.createElement('div');
        messageBubble.className = isUser ? 'alert alert-primary mb-0' : 'alert alert-success mb-0';
        messageBubble.style.maxWidth = '70%';

        const messageText = document.createElement('div');
        messageText.textContent = message;

        const timestampElement = document.createElement('small');
        timestampElement.className = 'text-muted d-block mt-1';
        timestampElement.textContent = timestampText;

        messageBubble.appendChild(messageText);
        messageBubble.appendChild(timestampElement);
        messageDiv.appendChild(messageBubble);
        chatContainer.appendChild(messageDiv);
        
        welcomeMessage.style.display = 'none';
        scrollToBottom();
    }

    // Send message to server
    function sendMessage() {
        const message = messageInput.value.trim();
        
        if (!message) {
            return;
        }

        // Disable input and show loading
        messageInput.disabled = true;
        sendBtn.disabled = true;
        sendText.classList.add('d-none');
        loadingSpinner.classList.remove('d-none');

        // Add user message to chat immediately
        addMessageToChat(message, true);
        messageInput.value = '';

        // Send to server
        fetch('/api/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            // Add bot response to chat
            addMessageToChat(data.bot_response, false, data.timestamp);
        })
        .catch(error => {
            console.error('Error sending message:', error);
            addMessageToChat('Sorry, I encountered an error. Please try again.', false);
        })
        .finally(() => {
            // Re-enable input and hide loading
            messageInput.disabled = false;
            sendBtn.disabled = false;
            sendText.classList.remove('d-none');
            loadingSpinner.classList.add('d-none');
            messageInput.focus();
        });
    }

    // Clear chat history
    function clearChatHistory() {
        if (confirm('Are you sure you want to clear the chat history?')) {
            fetch('/api/chat/clear', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    chatContainer.innerHTML = '';
                    welcomeMessage.style.display = 'block';
                    addMessageToChat("Chat history cleared. How can I help you today?", false);
                }
            })
            .catch(error => {
                alert('Failed to clear chat history');
                console.error('Error clearing chat:', error);
            });
        }
    }

    // Auto-focus on input
    messageInput.focus();
});
</script>

<style>
#chat-container {
    background-color: #f8f9fa;
}

.alert-primary {
    background-color: #007bff;
    color: white;
    border: none;
}

.alert-success {
    background-color: #28a745;
    color: white;
    border: none;
}

.quick-question {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

#chat-container::-webkit-scrollbar {
    width: 6px;
}

#chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chat-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#chat-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.d-flex.justify-content-end .alert {
    margin-left: auto;
}

.d-flex.justify-content-start .alert {
    margin-right: auto;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>
{% endblock %}